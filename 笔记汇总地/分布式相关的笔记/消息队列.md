

- AMQP协议

![2023-10-116:09:20-1696147760118.png](https://gitee.com/grsswh/drawing-bed/raw/master/image/2023-10-116:09:20-1696147760118.png)



- 三种MQ各自的优缺点

RabbitMQ

> RabbitMQ开始是用于电信业务的可靠通信的，也是少有的几款支持AMQP协议的产品之一。

- 优点：

1. 轻量级，快速，部署使用方便
2. 支持灵活的路由配置。RabbitMQ中，在生产者和队列之间有一个交换器模块。根据配置的路由规则，生产者发送的消息可以发送到不同的队列中，路由规则很灵活，还可以自己实现。
3. RabbitMQ的客户端支持大多数的编程语言。

- 缺点：

1. 如果有大量消息堆积在队列中，性能会急剧下降
2. RabbitMQ的性能在Kafka和RocketMQ中是最差的，每秒处理几万到几十万的消息，如果应用要求高的性能，不要选择RabbitMQ
3. RabbitMQ是Erlang开发的，功能扩展和二次开发代价很高。



RocketMQ

> RocketMQ是一个开源的消息队列，使用java实现。借鉴了kafka的设计并做了很多改进。RocketMQ主要用于有序，事务，流计算，消息推送，日志流处理，binlog分发等场景。经历了历次的双11考验，性能，稳定性可靠性没得说。

- 优点：

1. RocketMQ几乎具备了消息队列应该具备的所有特性和功能。
2. java开发，阅读源代码，扩展，二次开发方便。
3. 对电商领域的响应延迟做了很多优化，在大多数情况下，响应在毫秒级别。如果应用很关注响应时间，可以使用RocketMQ。
4. 性能比RabbitMQ高一个数量级，每秒处理几十万的消息。

- 缺点：

1. 跟周边系统的整合和兼容不是很好。



Kafka

> kafka是Scala和Java开发的，几乎所有相关的开源软件都支持Kafka。

- 优点：

1. Kafka高效，可伸缩，消息持久化。支持分区。副本和容错。
2. 对批处理和异步处理做了大量的设计，因此Kafka可以得到非常高的性能。
3. 它的异步消息的发送和接收是三个中最好的，但是和RocketMQ拉不开数量级，每秒处理几十万的消息。
4. 如果是异步消息，并且开启了压缩，kafka最终可以达到每秒处理2000W消息的级别。

- 缺点：

1. 由于是异步和批处理的，延迟也会高，不适合电商场景。







|                        | RabbitMQ   | RocketMQ                               | Kafka                          |
| ---------------------- | ---------- | -------------------------------------- | ------------------------------ |
| 单机吞吐量             | 1w量级     | 10w量级                                | 10w量级                        |
| 开发语言               | Erlang     | Java                                   | Java和Scala                    |
| 消息延迟               | 微秒       | 毫秒                                   | 毫秒                           |
| 消息丢失               | 可能性很低 | 参数优化后可以0丢失                    | 参数优化后可以0丢失            |
| 消费模式               | 推拉       | 推拉                                   | 拉取                           |
| 主题数量对吞吐量的影响 | \          | 几百上千个主题会对吞吐量有一个小的影响 | 几十上百个主题会极大影响吞吐量 |
| 可用性                 | 高（主从） | 很高（主从）                           | 很高（分布式）                 |



使用场景：

- 系统中存在读的高并发：

1. 使用缓存策略将缓存挡到上层中的缓存中
2. 能静态化的数据尽量静态化
3. 加入限流（比如对短时间之内来自某一个用户，某个IP、某个设备的重复请求做丢失处理）

- 写高并发：

1. 使用消息队列。



- 消息队列的作用

1. 削去秒杀场景下的峰值写流量--流量削峰
2. 通过异步处理简化秒杀请求中的业务流程--异步处理
3. 解耦，实现秒杀系统模块之间的松耦合----解耦





# 开源消息中间件RabbitMQ



架构图

![2023-10-117:04:30-1696151070927.png](https://gitee.com/grsswh/drawing-bed/raw/master/image/2023-10-117:04:30-1696151070927.png)

交换器的类型

> RabbitMQ常用的交换器类型有：fanout、direct、topic、headers四种。

- fanout

会把所有发送到该交换器的消息路由到所有与该交换器绑定的队列中，如图：

![2023-10-117:07:04-1696151224730.png](https://gitee.com/grsswh/drawing-bed/raw/master/image/2023-10-117:07:04-1696151224730.png)



- Direct

direct类型交换器路由规则很简单，把消息路由到那些bindingkey和routingkey完全匹配的队列中，如图：

