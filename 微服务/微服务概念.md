> 高内据，低耦合

# Eureka注册中心

## 服务调用出现的问题

- 服务消费者如何获取服务提供者的地址信息？
- 如果有多个提供者，消费者该如何选择？
- 消费者如何得知服务提供者的健康状态？



![](https://files.catbox.moe/6u23v0.png)



![](https://i.loli.net/2021/09/13/HxGozhLEkCmOIdR.png)



## Eureka步骤

- Eureka的搭建

![](https://i.loli.net/2021/09/13/lEWqJ3bXQMoe6Ot.png)



- 服务注册

 ![](https://i.loli.net/2021/09/13/NqiCh978pdXIkQU.png)



# Ribbon负载均衡

- 整体流程

![](https://i.loli.net/2021/09/13/dUHt74hZoxCBKvq.png)



##  IRule接口的策略

1. RoundRobinRule：简单轮询列表来选择服务器，它是Rinbon默认的负载均衡规则。
2. AvailabilityFilteringRule：对以下两种服务器进行忽略：（1）. 在默认情况下，这台服务器如果三次连接失败，这台服务器就会被设置为“短路”状态。短路状态将持续30秒，如果再次连接失败，短路的持续时间就会几何级的增加。（2）.并发数过高的服务器，如果如果一个服务器的并发连接数过高，配置了AVailabilityFilteringRule的客户端也会将其忽略。并发连接数的上限可以由客户端的<clientName>.<clientConfigNameSpace>.ActiveConnectionsLimit属性进行配置。
3. WeightedResponseTimeRule：为每一个服务器赋予一个权重值。服务器响应时间越长，这个服务器的权重就越小。这个规则会随机选择服务器，这个权重值会影响服务器的选择。
4. <font color="red">  ZoneAvoidanceRule</font>：以区域可用的服务器进行服务器的选择。使用zone对服务器进行分类，这个zone可以理解为一个机房，一个机架等。而后再对 zone里的多个服务进行轮询。
5. BestAvailableRule：忽略哪些短路的服务器，并选择并发数较低的服务器。
6. RandomRule：随机选择一个可用的服务器。
7. RetryRule：重试机制的选择逻辑。



- 配置负载均衡的方法：

![](https://i.loli.net/2021/09/14/DfgvCZ2GWR4Eqpc.png)



- Ribbon饥饿加载

> Rinbbon默认为懒加载，当需要时才会创建信息。

![](https://i.loli.net/2021/09/14/l5UMncZFiQvVJw4.png)



## 总结

![](https://i.loli.net/2021/09/14/h5XeUkC3EStzTuj.png)



# Nacos注册中心

> Nacos是阿里巴巴的产品，现在是springcloud中的一个组件。相比Eureka功能更加丰富，在国内更受欢迎。

 

## Nacos服务多级概念

> Nacos将相同的地区的机房的多个服务统一在一起作为一个集群，一个中心服务下有多个集群，一个集群对应一个地区的多个服务。相同集群的服务尽量调用相同集群的其他服务，本集群这样在地理上尽可能的减少了延迟。



Nacos默认不会采用集群就近调用，需要配置开启。

![](https://i.loli.net/2021/09/15/XxZbBQhEesg7CmJ.png)

优先访问本地集群，在本地集群内随机访问服务。



- 权重

权重设置在0~1之间。当权重设置为0时，不会去访问0权重的服务。

## 环境隔离

Nacos中服务存储和数据存储的最外层都是一个名为namespace的东西，用来做最外层的隔离。

>  两个命名隔间之间的服务无法互相访问。



## Nacos和Eureka的区别



- 生产者

Eureka每30秒都会对每个服务进行健康检测。

此心跳检测是由服务向Eureka发送请求。

Nacos会把服务分为临时实例和非临时实例。

临时实例Nacos会进行心跳检测，如果检测到心跳不跳动，就会直接清除掉此服务。

非临时实例不会进行心跳检测，而是由Nacos主动发送请求来确认服务是否存活。如果检测不存活，Nacos也不会把此服务从列表中清除。

![](https://i.loli.net/2021/09/15/L3HnvsjkaQN1B4g.png)



- 消费者

Eureka如果发现生产者服务有所改变，需要消费者主动去向Eureka去拉去服务信息。

Nacos采用pull和push两种，既可以消费者主动去拉取服务信息，也可以由Nacos主动去通知消费者服务变动信息。



## 统一配置管理
